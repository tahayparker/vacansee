name: Update Timetable Data

on:
  schedule:
    # Run every 4 hours
    - cron: "0 */4 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  update-timetable:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install supabase playwright-stealth beautifulsoup4 python-dotenv httpx postgrest playwright pyotp
          playwright install chromium

      - name: Set up environment variables
        env:
          SUPABASE_URL_SECRET: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY_SECRET: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          UOWD_EMAIL_SECRET: ${{ secrets.UOWD_EMAIL }}
          UOWD_PASSWORD_SECRET: ${{ secrets.UOWD_PASSWORD }}
          UOWD_TOTP_SECRET_SECRET: ${{ secrets.UOWD_TOTP_SECRET }}
        run: |
          echo "Setting environment variables..."
          if [ -z "$SUPABASE_URL_SECRET" ]; then echo "Error: SUPABASE_URL secret not set."; exit 1; fi
          if [ -z "$SUPABASE_SERVICE_KEY_SECRET" ]; then echo "Error: SUPABASE_SERVICE_ROLE_KEY secret not set."; exit 1; fi
          if [ -z "$UOWD_EMAIL_SECRET" ]; then echo "Error: UOWD_EMAIL secret not set."; exit 1; fi
          if [ -z "$UOWD_PASSWORD_SECRET" ]; then echo "Error: UOWD_PASSWORD secret not set."; exit 1; fi
          if [ -z "$UOWD_TOTP_SECRET_SECRET" ]; then echo "Error: UOWD_TOTP_SECRET secret not set."; exit 1; fi
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> $GITHUB_ENV
          echo "UOWD_EMAIL=${{ secrets.UOWD_EMAIL }}" >> $GITHUB_ENV
          echo "UOWD_PASSWORD=${{ secrets.UOWD_PASSWORD }}" >> $GITHUB_ENV
          echo "UOWD_TOTP_SECRET=${{ secrets.UOWD_TOTP_SECRET }}" >> $GITHUB_ENV
          echo "Environment variables configured."

      - name: Generate new timetable CSV data
        id: scrape
        run: |
          echo "Running authenticated timetable scraper..."
          python scripts/scrape_timetable_auth.py --output public/classes.csv
          exit_code=$?
          echo "Scraper finished with exit code $exit_code."
          # Fail the job only if exit code is non-zero AND not 1
          if [ $exit_code -ne 0 ] && [ $exit_code -ne 1 ]; then
            echo "::error::Scraper failed with critical exit code $exit_code!"
            exit $exit_code
          fi
          # If exit code was 1, the workflow continues

      - name: Compare Generated CSV with Repository CSV
        id: check_csv_changes
        run: |
          echo "Comparing generated classes.csv with repository version..."
          if [ ! -f public/classes.csv ]; then
            echo "::warning::Generated public/classes.csv not found. Skipping comparison and commit."
            # Set output to false if file doesn't exist, prevent commit attempt
            echo "csv_changed=false" >> $GITHUB_OUTPUT
          else
            # Stage the potentially new/modified file to compare against HEAD
            git add public/classes.csv
            if git diff --quiet HEAD -- public/classes.csv; then
              echo "No changes detected in classes.csv"
              echo "csv_changed=false" >> $GITHUB_OUTPUT
              # Unstage if no changes found
              git reset public/classes.csv
            else
              echo "Changes detected in classes.csv"
              echo "csv_changed=true" >> $GITHUB_OUTPUT
              # Keep the file staged for commit
            fi
          fi

      - name: Commit and push CSV changes
        # Only commit if changes were actually detected
        if: steps.check_csv_changes.outputs.csv_changed == 'true'
        run: |
          echo "Committing and pushing classes.csv changes..."
          git config user.name "Taha Parker via GitHub Actions"
          git config user.email "98612931+tahayparker@users.noreply.github.com"
          # File should already be staged from comparison step
          git commit -m "Update timetable CSV data [skip deploy]"
          git push

      - name: Update Rooms Table in DB
        id: update_rooms
        run: |
          echo "Running rooms update script..."
          python scripts/update_rooms.py
          exit_code=$?
          echo "Room update script finished with exit code $exit_code."
          if [ $exit_code -ne 0 ]; then
            echo "::error::Room update script failed with exit code $exit_code!"
            exit $exit_code
          fi

      - name: Upload Timetable to DB
        id: upload
        # This step runs regardless of CSV changes now
        run: |
          echo "Running timetable upload script..."
          python scripts/upload_timetable.py
          exit_code=$?
          echo "Upload script finished with exit code $exit_code."
          # Fail the job only if exit code is non-zero AND not 1
          if [ $exit_code -ne 0 ] && [ $exit_code -ne 1 ]; then
            echo "::error::Upload script failed with critical exit code $exit_code!"
            exit $exit_code
          fi

      - name: Generate Schedule JSON
        id: generate_json
        # This step runs regardless of CSV changes now
        run: |
          echo "Running schedule generation script..."
          python scripts/generate_schedule.py
          exit_code=$?
          echo "Schedule generation finished with exit code $exit_code."
          # Fail the job only if exit code is non-zero AND not 1
          if [ $exit_code -ne 0 ] && [ $exit_code -ne 1 ]; then
            echo "::error::Schedule generation failed with critical exit code $exit_code!"
            exit $exit_code
          fi
          # Always assume we might need to commit the JSON after generation
          echo "should_check_commit_json=true" >> $GITHUB_OUTPUT

      - name: Format scheduleData.json with Prettier
        run: |
          echo "Formatting scheduleData.json with Prettier..."
          npm install --no-save prettier
          npx prettier public/scheduleData.json --write

      - name: Commit and push JSON changes
        # Check if the previous step indicated we should check for commits
        if: steps.generate_json.outputs.should_check_commit_json == 'true'
        run: |
          echo "Checking for scheduleData.json changes..."
          # Stage the potentially new/modified JSON file
          git add public/scheduleData.json
          # Check if there are staged changes to commit before committing
          if ! git diff --staged --quiet; then
            echo "Changes detected in scheduleData.json. Committing..."
            git config user.name "Taha Parker via GitHub Actions"
            git config user.email "98612931+tahayparker@users.noreply.github.com"
            git commit -m "Update timetable JSON data [skip deploy]"
            git push
          else
            echo "No JSON changes to commit (file might be identical or generation failed before check)."
          fi

      - name: Cleanup # Optional: Add any other cleanup if needed
        run: |
          echo "Workflow finished."
          # rm -f some_other_temp_file.log # Example
